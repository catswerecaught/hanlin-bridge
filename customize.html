<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定制 - 翰林桥</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css?v=3">
    <link rel="stylesheet" href="customize.css">
</head>
<body>
    <header class="main-header">
        <div class="main-nav-container">
            <a href="index.html" class="logo"><img id="site-logo" src="images/logo.png" alt="翰林桥 Logo"></a>
            <nav class="main-nav">
                <ul>
                    <li class="nav-highlight"></li>
                    <li><a href="index.html">首页</a></li>
                    <li><a href="tutors.html">助学人</a></li>
                    <li><a href="trend.html">趋势</a></li>
                    <li><a href="lingning.html">灵凝</a></li>
                    <li><a href="customize.html" class="active">定制</a></li>
                    <li><a href="help.html">帮助</a></li>
                    <li><a href="cooperation.html">新闻</a></li>
                </ul>
            </nav>
            <div class="user-avatar" id="userAvatar">
                <img src="images/login-default.png" alt="登录" id="avatarImg">
            </div>
        </div>
    </header>

    <div class="login-modal" id="loginModal">
        <div class="login-modal-content">
            <span class="login-close-btn" id="loginCloseBtn">&times;</span>
            <h2>登录</h2>
            <form id="loginForm">
                <input type="text" id="loginUsername" placeholder="用户名/账号" autocomplete="username" required>
                <input type="password" id="loginPassword" placeholder="密码" autocomplete="current-password" required>
                <button type="submit">登录</button>
            </form>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <main class="customize-content">
        <div class="customize-header">
            <h1>定制服务中心</h1>
            <p>内部测试中，更多功能敬请期待。</p>
        </div>

        <div class="services-container">
            <div class="services-scroll">
                <div class="service-card" id="askQuestionCard">
                    <div class="card-header">
                        <span class="card-subtitle">想知道更多关于陶的信息？</span>
                        <h3>"问一问"活动进行中。</h3>
                    </div>
                    <div class="card-image">
                        <div class="device-mockup">
                            <div class="laptop"></div>
                            <div class="tablet"></div>
                            <div class="phone"></div>
                        </div>
                    </div>
                </div>
                
                <div class="service-card" id="techSupportCard">
                    <div class="card-header">
                        <span class="card-subtitle">Hanlin ITO</span>
                        <h3>遇到技术问题？联系Hanlin ITO专家为您解答。</h3>
                    </div>
                    <div class="card-image">
                        <div class="tech-support-avatar"></div>
                    </div>
                </div>
                
                <div class="service-card" id="discountCard">
                    <div class="card-header">
                        <span class="card-subtitle">定制问卷</span>
                        <h3>点击进入“悠然问卷”。</h3>
                    </div>
                    <div class="card-image">
                        <div class="discount-visual"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ask Question Modal -->
        <div class="modal" id="askQuestionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>问一问</h2>
                    <span class="close-btn" id="closeAskModal">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="question-section">
                        <h3>向陶提问</h3>
                        <p>匿名提问，您的问题将直接发送给陶先生</p>
                        <textarea id="questionInput" placeholder="请输入您想问的问题：" rows="6"></textarea>
                        <button id="submitQuestion" class="submit-btn">提交问题</button>
                        
                        <div id="questionResult" class="result-section" style="display: none;">
                            <h4>问题提交成功！</h4>
                            <p>您的查询密钥：</p>
                            <div class="key-display">
                                <span id="generatedKey"></span>
                                <button id="copyKey" class="copy-btn">复制</button>
                            </div>
                            <p class="key-note">请保存此密钥，您可以使用它查看回答</p>
                        </div>
                    </div>
                    
                    <div class="answer-section">
                        <h3>查看回答</h3>
                        <p>输入您的查询密钥查看陶先生的回答</p>
                        <div class="key-input-group">
                            <input type="text" id="keyInput" placeholder="请输入查询密钥">
                            <button id="checkAnswer" class="check-btn">查看回答</button>
                        </div>
                        
                        <div id="answerResult" class="result-section" style="display: none;">
                            <div class="question-display">
                                <h4>您的问题：</h4>
                                <p id="displayQuestion"></p>
                            </div>
                            <div class="answer-display">
                                <h4>陶先生的回答：</h4>
                                <p id="displayAnswer"></p>
                                <span class="answer-time" id="answerTime"></span>
                            </div>
                        </div>
                        
                        <div id="noAnswerResult" class="result-section" style="display: none;">
                            <p>暂无回答或密钥无效，请稍后再试</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="users.js"></script>
    <script src="script.js?v=3"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 卡片点击事件
            const askQuestionCard = document.getElementById('askQuestionCard');
            const askQuestionModal = document.getElementById('askQuestionModal');
            const closeAskModal = document.getElementById('closeAskModal');
            
            // 打开问一问模态框
            askQuestionCard.addEventListener('click', function() {
                askQuestionModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });
            
            // 关闭模态框
            closeAskModal.addEventListener('click', function() {
                askQuestionModal.style.display = 'none';
                document.body.style.overflow = 'auto';
                resetModal();
            });
            
            // 点击模态框外部关闭
            askQuestionModal.addEventListener('click', function(e) {
                if (e.target === askQuestionModal) {
                    askQuestionModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    resetModal();
                }
            });
            
            // 重置模态框状态
            function resetModal() {
                document.getElementById('questionInput').value = '';
                document.getElementById('keyInput').value = '';
                document.getElementById('questionResult').style.display = 'none';
                document.getElementById('answerResult').style.display = 'none';
                document.getElementById('noAnswerResult').style.display = 'none';
            }
            
            // 提交问题
            document.getElementById('submitQuestion').addEventListener('click', async function() {
                const questionInput = document.getElementById('questionInput');
                const question = questionInput.value.trim();
                
                if (!question) {
                    alert('请输入您的问题');
                    return;
                }
                
                if (question.length > 200) {
                    alert('问题长度不能超过200字符');
                    return;
                }
                
                const submitBtn = this;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '提交中...';
                submitBtn.disabled = true;
                
                try {
                    const response = await fetch('/api/questions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ question })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        // 显示成功结果
                        document.getElementById('generatedKey').textContent = data.key;
                        document.getElementById('questionResult').style.display = 'block';
                        questionInput.value = '';
                    } else {
                        alert(data.error || '提交失败，请稍后重试');
                    }
                } catch (error) {
                    console.error('Submit question error:', error);
                    alert('网络错误，请稍后重试');
                } finally {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });
            
            // 复制密钥
            document.getElementById('copyKey').addEventListener('click', function() {
                const key = document.getElementById('generatedKey').textContent;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(key).then(() => {
                        const btn = this;
                        const originalText = btn.textContent;
                        btn.textContent = '已复制';
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 2000);
                    }).catch(() => {
                        fallbackCopyTextToClipboard(key);
                    });
                } else {
                    fallbackCopyTextToClipboard(key);
                }
            });
            
            // 备用复制方法
            function fallbackCopyTextToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.top = '0';
                textArea.style.left = '0';
                textArea.style.position = 'fixed';
                
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        const btn = document.getElementById('copyKey');
                        const originalText = btn.textContent;
                        btn.textContent = '已复制';
                        setTimeout(() => {
                            btn.textContent = originalText;
                        }, 2000);
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                
                document.body.removeChild(textArea);
            }
            
            // 查看回答
            document.getElementById('checkAnswer').addEventListener('click', async function() {
                const keyInput = document.getElementById('keyInput');
                const key = keyInput.value.trim();
                
                if (!key) {
                    alert('请输入查询密钥');
                    return;
                }
                
                if (!/^[a-z0-9]{4}-[a-z0-9]{4}-[a-z0-9]{4}$/.test(key)) {
                    alert('密钥格式无效，正确格式为：xxxx-xxxx-xxxx');
                    return;
                }
                
                const checkBtn = this;
                const originalText = checkBtn.textContent;
                checkBtn.textContent = '查询中...';
                checkBtn.disabled = true;
                
                // 隐藏之前的结果
                document.getElementById('answerResult').style.display = 'none';
                document.getElementById('noAnswerResult').style.display = 'none';
                
                try {
                    const response = await fetch(`/api/questions?key=${encodeURIComponent(key)}`);
                    const data = await response.json();
                    
                    if (response.ok) {
                        if (data.hasAnswer) {
                            // 显示问题和答案
                            document.getElementById('displayQuestion').textContent = data.question;
                            document.getElementById('displayAnswer').textContent = data.answer;
                            document.getElementById('answerTime').textContent = 
                                `回答时间：${new Date(data.answerTime).toLocaleString('zh-CN')}`;
                            document.getElementById('answerResult').style.display = 'block';
                        } else {
                            // 显示暂无回答
                            document.getElementById('noAnswerResult').style.display = 'block';
                        }
                    } else {
                        document.getElementById('noAnswerResult').style.display = 'block';
                    }
                } catch (error) {
                    console.error('Check answer error:', error);
                    alert('网络错误，请稍后重试');
                } finally {
                    checkBtn.textContent = originalText;
                    checkBtn.disabled = false;
                }
            });
            
            // 其他服务卡片的点击事件（暂时显示提示）
            document.getElementById('techSupportCard').addEventListener('click', function() {
                alert('技术支持服务即将上线，敬请期待！');
            });
            
            document.getElementById('discountCard').addEventListener('click', function() {
                window.location.href = 'questionnaire.html';
            });
        });
    </script>
</body>
</html>
